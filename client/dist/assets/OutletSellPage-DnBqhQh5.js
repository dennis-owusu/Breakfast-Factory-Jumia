import{a as ie,r as c,a8 as L,a9 as le,j as e,c as z,g as de,I as g,J as D,aa as H,ab as A,d as N,ac as G,B as j,n as B,ad as me,ae as ue,af as pe,T as he,ag as ye,ah as K,a2 as V,b as k,e as n}from"./index-CW7sJ-MG.js";const be=()=>{const{currentUser:a}=ie(s=>s.user),[b,W]=c.useState([]),[T,v]=c.useState([]),[f,Q]=c.useState(""),[p,x]=c.useState([]),[X,I]=c.useState(!1),[M,w]=c.useState(!1),[u,P]=c.useState({name:"",phoneNumber:"",email:""}),[d,S]=c.useState("cashOnDelivery"),[fe,Y]=c.useState(null),[_,F]=c.useState(!1),[xe,Z]=c.useState(!1),[Ne,q]=c.useState(null),C=c.useRef(null),[$,U]=c.useState(L()),ee=le({reference:$,email:(a==null?void 0:a.email)||"outlet@example.com",amount:y()*100,publicKey:"pk_live_65d9322bc5838ebd4b03899c8dfe26bae89d4114",currency:"GHS",split_code:"SPL_WfnzrRz3O1"}),se=()=>{ee({onSuccess:ae,onClose:te})};c.useEffect(()=>{_&&(se(),F(!1))},[_]);const ae=async s=>{try{if((await fetch("http://localhost:3000/api/route/payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referenceId:s.reference,userId:a._id,orderId:C.current,amount:y(),phoneNumber:a==null?void 0:a.phoneNumber,currency:"GHS",payerEmail:(a==null?void 0:a.email)||"outlet@example.com",paymentMethod:"paystack",status:"paid"})})).ok)Z(!0),x([]),P({name:"",phoneNumber:"",email:""}),S("cashOnDelivery"),U(L()),n.success("Payment successful and order processed!");else throw new Error("Failed to save transaction.")}catch(t){q(t.message),n.error("Failed to save transaction.")}},te=async()=>{try{await fetch("http://localhost:3000/api/route/payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referenceId:$,userId:a._id,orderId:C.current,amount:y(),paymentMethod:"paystack",currency:"GHS",payerEmail:(a==null?void 0:a.email)||"outlet@example.com",phoneNumber:a==null?void 0:a.phoneNumber,status:"failed"})})}catch(s){console.error("Failed to log failed transaction:",s)}q("Payment popup closed."),n.error("Payment was not completed.")};c.useEffect(()=>{a&&(async()=>{try{I(!0);const t={"Content-Type":"application/json",...(a==null?void 0:a.token)&&{Authorization:`Bearer ${a.token}`}},r=await fetch("/api/route/allproducts",{headers:t});if(!r.ok)throw new Error(`HTTP error ${r.status}: ${r.statusText}`);const o=await r.json();W(o.products||[]),v(o.products||[])}catch(t){console.error("Error fetching products:",t),n.error("Failed to load products")}finally{I(!1)}})()},[a]),c.useEffect(()=>{if(f.trim()==="")v(b);else{const s=b.filter(t=>{var r;return t.productName.toLowerCase().includes(f.toLowerCase())||((r=t.description)==null?void 0:r.toLowerCase().includes(f.toLowerCase()))});v(s)}},[f,b]);const re=async s=>{try{const r=await(await fetch(`/api/route/product/${s._id}`)).json();if(!r.success)throw new Error(r.message||"Failed to fetch product");const o=r.product,m=p.find(l=>l._id===s._id),i=m?m.quantity+1:1;if(o.numberOfProductsAvailable<i){n.error(`${o.productName} is out of stock or insufficient quantity`);return}x(l=>m?l.map(h=>h._id===s._id?{...h,quantity:i}:h):[...l,{...o,quantity:1}]),n.success(`${o.productName} added to cart`)}catch(t){console.error("Error adding to cart:",t),n.error("Failed to add to cart. Please try again.")}},R=async(s,t)=>{if(!(t<1))try{const o=await(await fetch(`/api/route/product/${s}`)).json();if(!o.success)throw new Error(o.message||"Failed to fetch product");const m=o.product;if(m.numberOfProductsAvailable<t){n.error(`${m.productName} has only ${m.numberOfProductsAvailable} in stock`);return}x(i=>i.map(l=>l._id===s?{...l,quantity:t}:l))}catch(r){console.error("Error updating quantity:",r),n.error("Failed to update quantity. Please try again.")}},oe=s=>{x(t=>t.filter(r=>r._id!==s)),n.success("Item removed from cart")};function E(){return p.reduce((s,t)=>s+t.productPrice*t.quantity,0)}function J(){const s=E();return d==="paystack"||d==="mtnMomo"?s*.02:0}function y(){return E()+J()}const O=s=>{const{name:t,value:r}=s.target;P(o=>({...o,[t]:r}))},ne=async()=>{if(p.length===0){n.error("Cart is empty");return}if(d==="paystack"&&(!(a!=null&&a.email)||!a.email.trim())){n.error("Email is required for Paystack payment");return}if(d==="mtnMomo"&&(!(a!=null&&a.phoneNumber)||!(a!=null&&a.phoneNumber.trim()))){n.error("Phone number is required for MTN Mobile Money payment");return}try{w(!0);const s={userInfo:{name:u.name||"No customer name",email:u.email||a.email||"No email",phoneNumber:u.phoneNumber||"No phone Number"},products:p.map(i=>({product:i._id,quantity:i.quantity})),totalPrice:y(),address:"In-store purchase",city:"In-store",state:"In-store",phoneNumber:u.phoneNumber||"0000000000",postalCode:"00000",paymentMethod:d,status:d==="cashOnDelivery"?"delivered":"pending"},t={"Content-Type":"application/json",...(a==null?void 0:a.token)&&{Authorization:`Bearer ${a.token}`}};if(d==="mtnMomo")try{const i=await fetch("/api/route/payments/mtn-momo/initiate",{method:"POST",headers:t,body:JSON.stringify({phoneNumber:u.phoneNumber,amount:y(),description:`Payment for order at ${a.outletName||"our outlet"}`})});let l;const h=await i.text();try{if(h)l=JSON.parse(h);else throw new Error("Empty response received from payment gateway")}catch(ce){throw console.error("JSON parsing error:",ce,"Response text:",h),new Error(`Failed to parse payment response: ${h||"Empty response"}`)}if(!i.ok)throw new Error((l==null?void 0:l.message)||`HTTP error ${i.status}`);n.success(`Payment request sent to ${u.phoneNumber}. Please ask customer to check their phone and enter their PIN to complete payment.`),s.momoTransactionId=l.transactionId}catch(i){console.error("Error initiating MTN Mobile Money payment:",i),n.error(i.message||"Failed to initiate mobile money payment"),w(!1);return}const r=await fetch("/api/route/createOrder",{method:"POST",headers:t,body:JSON.stringify(s)});let o;const m=await r.text();try{if(m)o=JSON.parse(m);else throw new Error("Empty response received from server")}catch(i){throw console.error("JSON parsing error:",i,"Response text:",m),new Error(`Failed to parse order response: ${m||"Empty response"}`)}if(!r.ok)throw new Error((o==null?void 0:o.message)||`HTTP error ${r.status}`);if(Y(o._id),C.current=o._id,d==="paystack"){F(!0);return}d==="cashOnDelivery"?n.success("Order processed successfully!"):n.success("Order created! Waiting for payment confirmation."),x([]),P({name:"",phoneNumber:"",email:""}),S("cashOnDelivery")}catch(s){console.error("Error processing order:",s),n.error(s.message||"Failed to process order")}finally{w(!1)}};return X?e.jsx(z,{}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Process In-Store Sale"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"}),e.jsx(g,{type:"text",placeholder:"Search products...",className:"pl-10",value:f,onChange:s=>Q(s.target.value)})]})}),T.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"No products found"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:T.map(s=>e.jsxs(D,{className:"overflow-hidden",children:[e.jsx("div",{className:"aspect-square overflow-hidden",children:e.jsx("img",{src:s.productImage,alt:s.productName,className:"w-full h-full object-cover transition-transform hover:scale-105"})}),e.jsxs(H,{className:"p-4",children:[e.jsx(A,{className:"text-lg",children:s.productName}),e.jsx("p",{className:"font-semibold text-orange-600",children:N(s.productPrice)})]}),e.jsx(G,{className:"p-4 pt-0",children:e.jsxs(j,{onClick:()=>re(s),className:"w-full bg-orange-600 hover:bg-orange-700",children:[e.jsx(B,{className:"mr-2 h-4 w-4"})," Add to Cart"]})})]},s._id))})]}),e.jsx("div",{children:e.jsxs(D,{children:[e.jsx(H,{children:e.jsxs(A,{className:"flex items-center",children:[e.jsx(me,{className:"mr-2"}),"Cart (",p.length,")"]})}),e.jsxs(ue,{children:[p.length===0?e.jsx("p",{className:"text-center text-gray-500 py-4",children:"Cart is empty"}):e.jsx("div",{className:"space-y-4",children:p.map(s=>e.jsxs("div",{className:"flex justify-between items-center border-b pb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:s.productName}),e.jsxs("p",{className:"text-sm text-gray-600",children:[N(s.productPrice)," Ã— ",s.quantity]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>R(s._id,s.quantity-1),children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsx("span",{className:"w-8 text-center",children:s.quantity}),e.jsx(j,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>R(s._id,s.quantity+1),children:e.jsx(B,{className:"h-4 w-4"})}),e.jsx(j,{variant:"ghost",size:"icon",className:"h-8 w-8 text-red-500",onClick:()=>oe(s._id),children:e.jsx(he,{className:"h-4 w-4"})})]})]},s._id))}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("h3",{className:"font-semibold",children:"Customer Information (Optional)"}),e.jsx(g,{placeholder:"Customer Name",name:"name",onChange:O}),e.jsx(g,{placeholder:"Phone Number",name:"phoneNumber",value:u.phoneNumber,onChange:O,className:d==="mtnMomo"?"border-orange-500":""}),d==="mtnMomo"&&e.jsx("p",{className:"text-xs text-orange-600",children:"* Required for MTN Mobile Money payment"}),e.jsx(g,{placeholder:"Email",name:"email",type:"email",defaultValue:u.email?u.email:a.email,onChange:O})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("h3",{className:"font-semibold",children:"Payment Method"}),e.jsxs(ye,{value:d,onValueChange:S,className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{value:"paystack",id:"paystack"}),e.jsxs(V,{htmlFor:"paystack",className:"flex items-center",children:[e.jsx(k,{className:"mr-2 h-4 w-4"})," Mobile Money"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{value:"cashOnDelivery",id:"cashOnDelivery"}),e.jsxs(V,{htmlFor:"cashOnDelivery",className:"flex items-center",children:[e.jsx(k,{className:"mr-2 h-4 w-4 text-gray-500"}),"Cash Payment"]})]})]})]}),e.jsx("div",{className:"mt-6 pt-4 border-t",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:N(E())})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Processing Fee (2%):"}),e.jsx("span",{children:N(J())})]}),e.jsxs("div",{className:"flex justify-between font-semibold text-lg pt-2 border-t",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:N(y())})]})]})})]}),e.jsx(G,{children:e.jsx(j,{className:"w-full bg-orange-600 hover:bg-orange-700 flex items-center justify-center",disabled:p.length===0||M,onClick:ne,children:M?e.jsx(z,{className:"h-5 w-5"}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"mr-2 h-5 w-5"}),"Process Payment"]})})})]})})]})]})};export{be as default};
